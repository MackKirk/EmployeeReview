{% extends 'base.html' %}
{% block title %}Administration{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto bg-white p-8 rounded-xl shadow space-y-6">
  <h1 class="text-3xl font-bold text-gray-800">Administration</h1>

  <div class="flex items-center justify-between">
    <a href="/admin/questions" class="bg-gray-100 text-gray-800 px-4 py-2 rounded hover:bg-gray-200">Edit Questions</a>
  </div>

  <div class="mt-4 border border-red-300 bg-red-50 rounded-lg p-4">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-red-700 font-semibold">Danger zone</h2>
      <span class="text-red-600 text-sm">Bulk email actions</span>
    </div>
    <div class="space-x-2">
      <form method="post" action="/admin/send-review-links" class="inline" data-confirm>
        <input type="hidden" name="role" value="employee">
        <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Send to Employees</button>
      </form>
      <form method="post" action="/admin/send-review-links" class="inline" data-confirm>
        <input type="hidden" name="role" value="supervisor">
        <button class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Send to Supervisors</button>
      </form>
      <form method="post" action="/admin/send-review-links" class="inline" data-confirm>
        <input type="hidden" name="role" value="administration">
        <button class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">Send to Administration</button>
      </form>
      <form method="post" action="/admin/send-review-links" class="inline" data-confirm>
        <button class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Send to All</button>
      </form>
      <form method="post" action="/admin/send-test-email" class="inline" onsubmit="return confirm('Send a test email?');">
        <input type="email" name="to" placeholder="test@example.com" class="border rounded px-3 py-2" required>
        <button class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-black">Send test email</button>
      </form>
    </div>
  </div>

  {% if message %}
    <div class="p-3 rounded bg-green-50 text-green-800 border border-green-200">{{ message }}</div>
  {% endif %}
  {% if error %}
    <div class="p-3 rounded bg-red-50 text-red-800 border border-red-200">{{ error }}</div>
  {% endif %}

  <div class="flex justify-end mb-3">
    <input id="admin-search" type="text" placeholder="Search name..." class="border rounded px-3 py-2 w-64" autocomplete="off">
  </div>

  <div class="overflow-x-auto">
    <table id="admin-table" class="w-full table-auto border border-gray-300 rounded-md overflow-hidden">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="p-3 text-left">Name</th>
          <th class="p-3 text-left">Role</th>
          <th class="p-3 text-left">Supervisor</th>
          <th class="p-3 text-center">Self</th>
          <th class="p-3 text-center">Supervisor</th>
          <th class="p-3 text-center">Director</th>
          <th class="p-3 text-center">Email</th>
          <th class="p-3 text-center">Clicked</th>
          <th class="p-3 text-center">Action</th>
        </tr>
      </thead>
      <tbody class="text-sm text-gray-700 divide-y divide-gray-200">
        {% for row in rows %}
        <tr class="hover:bg-gray-50">
          <td class="p-3 font-medium">{{ row.employee.name }}</td>
          <td class="p-3">
            <form method="post" action="/admin/update-employee/{{ row.employee.id }}" class="flex items-center space-x-2" data-emp-id="{{ row.employee.id }}">
              <span class="role-display" data-emp-id="{{ row.employee.id }}">{{ row.employee.role }}</span>
              <select name="role" class="border rounded px-2 py-1" style="display:none;" disabled data-role-select data-emp-id="{{ row.employee.id }}">
                {% for r in allowed_roles %}
                  <option value="{{ r }}" {% if row.employee.role == r %}selected{% endif %}>{{ r }}</option>
                {% endfor %}
              </select>
          </td>
          <td class="p-3">
              <span class="sup-display" data-emp-id="{{ row.employee.id }}">{{ row.employee.supervisor_email or '‚Äî' }}</span>
              <select name="supervisor_name" class="border rounded px-2 py-1 w-56" style="display:none;" disabled data-sup-select data-emp-id="{{ row.employee.id }}">
                <option value="">None</option>
                {% for n in names %}
                  <option value="{{ n }}" {% if row.employee.supervisor_email == n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
          </td>
          <td class="p-3 text-center">{% if row.employee_done %}‚úÖ{% else %}‚ùå{% endif %}</td>
          <td class="p-3 text-center">{% if row.supervisor_done %}‚úÖ{% else %}‚ùå{% endif %}</td>
          <td class="p-3 text-center">{% if row.director_done %}‚úÖ{% else %}‚ùå{% endif %}</td>
          <td class="p-3 text-center">{% if row.has_sent %}üìß{% else %}‚Äî{% endif %}</td>
          <td class="p-3 text-center">{% if row.has_clicked %}üü¢{% else %}‚Äî{% endif %}</td>
          <td class="p-3 text-center">
              <button type="button" class="edit-row text-gray-700 hover:text-black" title="Edit" data-emp-id="{{ row.employee.id }}">‚úèÔ∏è</button>
              <button type="submit" class="save-row ml-2 bg-gray-100 px-2 py-1 rounded hover:bg-gray-200" style="display:none;" title="Save" data-emp-id="{{ row.employee.id }}">üíæ</button>
            </form>
            <form method="post" action="/admin/send-review-link/{{ row.employee.id }}" class="inline">
              <button class="ml-2" title="Send email">‚úâÔ∏è</button>
            </form>
            <a href="/director/review/{{ row.employee.id }}" class="ml-3 text-gray-700 hover:underline" title="View compare">üëÅÔ∏è</a>
            <a href="/admin/open-review/{{ row.employee.id }}" class="ml-3 text-gray-700 hover:underline" title="Open as user" target="_blank">üîó</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    
  </div>
  <script>
    (function() {
      function toggleEdit(empId, editing) {
        var roleDisp = document.querySelector('.role-display[data-emp-id="' + empId + '"]');
        var roleSel = document.querySelector('select[data-role-select][data-emp-id="' + empId + '"]');
        var supDisp = document.querySelector('.sup-display[data-emp-id="' + empId + '"]');
        var supSel = document.querySelector('select[data-sup-select][data-emp-id="' + empId + '"]');
        var saveBtn = document.querySelector('button.save-row[data-emp-id="' + empId + '"]');
        var editBtn = document.querySelector('button.edit-row[data-emp-id="' + empId + '"]');
        if (!roleDisp || !roleSel || !supDisp || !supSel || !saveBtn || !editBtn) return;
        if (editing) {
          roleDisp.style.display = 'none';
          supDisp.style.display = 'none';
          roleSel.style.display = '';
          supSel.style.display = '';
          roleSel.disabled = false;
          supSel.disabled = false;
          saveBtn.style.display = '';
          editBtn.style.display = 'none';
        } else {
          roleDisp.style.display = '';
          supDisp.style.display = '';
          roleSel.style.display = 'none';
          supSel.style.display = 'none';
          roleSel.disabled = true;
          supSel.disabled = true;
          saveBtn.style.display = 'none';
          editBtn.style.display = '';
          // Update display text with current selections
          var roleText = roleSel.options[roleSel.selectedIndex].textContent;
          roleDisp.textContent = roleText;
          var supText = supSel.options[supSel.selectedIndex] ? supSel.options[supSel.selectedIndex].textContent : '‚Äî';
          supDisp.textContent = supText || '‚Äî';
        }
      }
      document.querySelectorAll('button.edit-row').forEach(function(btn){
        btn.addEventListener('click', function(){
          var id = btn.getAttribute('data-emp-id');
          toggleEdit(id, true);
        });
      });

      // Name filter
      var search = document.getElementById('admin-search');
      var tbody = document.querySelector('#admin-table tbody');
      function applyFilter() {
        var q = (search.value || '').toLowerCase().trim();
        if (!tbody) return;
        tbody.querySelectorAll('tr').forEach(function(row){
          var nameCell = row.querySelector('td');
          var name = nameCell ? (nameCell.textContent || '').toLowerCase() : '';
          row.style.display = !q || name.indexOf(q) !== -1 ? '' : 'none';
        });
      }
      if (search) {
        search.addEventListener('input', applyFilter);
      }

      // Confirm bulk sends
      document.querySelectorAll('form[data-confirm]').forEach(function(f){
        f.addEventListener('submit', function(e){
          var ok = confirm('‚ö†Ô∏è Are you sure you want to send these emails?');
          if (!ok) {
            e.preventDefault();
          }
        });
      });
    })();
  </script>
</div>
{% endblock %}


