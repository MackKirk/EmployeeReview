{% extends 'base.html' %}
{% block title %}Administration{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto bg-white p-8 rounded-xl shadow space-y-6">
  <h1 class="text-3xl font-bold text-gray-800">Administration</h1>

  <div class="flex items-center justify-between">
    <div class="space-x-2">
      <a href="/admin/questions" class="bg-gray-100 text-gray-800 px-4 py-2 rounded hover:bg-gray-200">Edit Questions</a>
      <a href="/admin/ui" class="bg-gray-100 text-gray-800 px-4 py-2 rounded hover:bg-gray-200">Edit UI Text</a>
      <a href="/admin/schedule" class="bg-gray-100 text-gray-800 px-4 py-2 rounded hover:bg-gray-200">View Schedule</a>
    </div>
  </div>

  <div class="mt-4 border border-red-300 bg-red-50 rounded-lg p-4">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-red-700 font-semibold">Danger zone</h2>
      <span class="text-red-600 text-sm">Bulk email actions</span>
    </div>
    <div class="space-x-2">
      <form method="post" action="/admin/send-review-links" class="inline" data-confirm>
        <input type="hidden" name="role" value="employee">
        <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Send to Employees</button>
      </form>
      <form method="post" action="/admin/send-review-links" class="inline" data-confirm>
        <input type="hidden" name="role" value="supervisor">
        <button class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Send to Supervisors</button>
      </form>
      <form method="post" action="/admin/send-review-links" class="inline" data-confirm>
        <input type="hidden" name="role" value="administration">
        <button class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">Send to Administration</button>
      </form>
      <form method="post" action="/admin/send-review-links" class="inline" data-confirm>
        <button class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Send to All</button>
      </form>
      <form method="post" action="/admin/send-test-email" class="inline" onsubmit="return confirm('Send a test email?');">
        <input type="email" name="to" placeholder="test@example.com" class="border rounded px-3 py-2" required>
        <button class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-black">Send test email</button>
      </form>
    </div>
  </div>

  {% if message %}
    <div class="p-3 rounded bg-green-50 text-green-800 border border-green-200">{{ message }}</div>
  {% endif %}
  {% if error %}
    <div class="p-3 rounded bg-red-50 text-red-800 border border-red-200">{{ error }}</div>
  {% endif %}

  <div class="flex items-center justify-between mb-3">
    <div class="flex items-center gap-2">
      <input id="admin-search" type="text" placeholder="Search name..." class="border rounded px-3 py-2 w-64" autocomplete="off">
      <select id="admin-filter-role" class="border rounded px-2 py-2">
        <option value="">All roles</option>
        {% for r in allowed_roles %}
        <option value="{{ r }}">{{ r }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <div class="flex items-center justify-between mb-3">
    <div class="text-sm text-gray-600">Bulk actions</div>
    <div class="space-x-2">
      <button id="bulk-edit-sup" type="button" class="bg-gray-100 text-gray-800 px-4 py-2 rounded hover:bg-gray-200">Bulk edit supervisors</button>
      <button id="bulk-save-sup" type="button" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" style="display:none;">Save all</button>
      <button id="bulk-cancel-sup" type="button" class="bg-gray-100 text-gray-800 px-4 py-2 rounded hover:bg-gray-200" style="display:none;">Cancel</button>
      <span class="inline-block w-3"></span>
      <button id="bulk-edit-role" type="button" class="bg-gray-100 text-gray-800 px-4 py-2 rounded hover:bg-gray-200">Bulk edit roles</button>
      <button id="bulk-save-role" type="button" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" style="display:none;">Save all</button>
      <button id="bulk-cancel-role" type="button" class="bg-gray-100 text-gray-800 px-4 py-2 rounded hover:bg-gray-200" style="display:none;">Cancel</button>
    </div>
  </div>

  <div class="overflow-x-auto">
    <table id="admin-table" class="w-full table-auto border border-gray-300 rounded-md overflow-hidden">
      <thead class="bg-gray-100 text-gray-700">
        <tr>
          <th class="p-3 text-left cursor-pointer select-none" data-sort="name">Name<span class="ml-1 sort-indicator"></span></th>
          <th class="p-3 text-left cursor-pointer select-none" data-sort="role">Role<span class="ml-1 sort-indicator"></span></th>
          <th class="p-3 text-left cursor-pointer select-none" data-sort="supervisor">Supervisor<span class="ml-1 sort-indicator"></span></th>
          <th class="p-3 text-left cursor-pointer select-none" data-sort="schedule">Self schedule<span class="ml-1 sort-indicator"></span></th>
          <th class="p-3 text-center cursor-pointer select-none" data-sort="self_done">Self<span class="ml-1 sort-indicator"></span></th>
          <th class="p-3 text-center cursor-pointer select-none" data-sort="supervisor_done">Supervisor<span class="ml-1 sort-indicator"></span></th>
          <th class="p-3 text-center cursor-pointer select-none" data-sort="director_done">Director<span class="ml-1 sort-indicator"></span></th>
          <th class="p-3 text-center cursor-pointer select-none" data-sort="email">Email<span class="ml-1 sort-indicator"></span></th>
          <th class="p-3 text-center cursor-pointer select-none" data-sort="clicked">Clicked<span class="ml-1 sort-indicator"></span></th>
          <th class="p-3 text-center sticky right-0 bg-gray-100">Action</th>
        </tr>
      </thead>
      <tbody class="text-sm text-gray-700 divide-y divide-gray-200">
        {% for row in rows %}
        <tr class="hover:bg-gray-50">
          <td class="p-3 font-medium">{{ row.employee.name }}</td>
          <td class="p-3">
            <form id="row-form-{{ row.employee.id }}" method="post" action="/admin/update-employee/{{ row.employee.id }}" class="flex items-center space-x-2" data-emp-id="{{ row.employee.id }}">
              <span class="role-display" data-emp-id="{{ row.employee.id }}">{{ row.employee.role }}</span>
              <select name="role" class="border rounded px-2 py-1" style="display:none;" disabled data-role-select data-emp-id="{{ row.employee.id }}" form="row-form-{{ row.employee.id }}">
                {% for r in allowed_roles %}
                  <option value="{{ r }}" {% if row.employee.role == r %}selected{% endif %}>{{ r }}</option>
                {% endfor %}
              </select>
          </td>
          <td class="p-3">
              <span class="sup-display" data-emp-id="{{ row.employee.id }}">{{ row.employee.supervisor_email or '‚Äî' }}</span>
              <select name="supervisor_name" class="border rounded px-2 py-1 w-56" style="display:none;" disabled data-sup-select data-emp-id="{{ row.employee.id }}" form="row-form-{{ row.employee.id }}">
                <option value="">None</option>
                {% for n in names %}
                  <option value="{{ n }}" {% if row.employee.supervisor_email == n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
          </td>
          <td class="p-3">
              <span class="sched-display text-gray-700" data-emp-id="{{ row.employee.id }}">{{ row.self_scheduled_at_display or '‚Äî' }}</span>
              <input type="datetime-local"
                     name="self_scheduled_at"
                     value="{{ row.self_scheduled_at_value }}"
                     class="border rounded px-2 py-1"
                     style="display:none;"
                     disabled
                     data-sched-input
                     data-emp-id="{{ row.employee.id }}"
                     form="row-form-{{ row.employee.id }}">
          </td>
          <td class="p-3 text-center">{% if row.employee_done %}‚úÖ{% else %}‚ùå{% endif %}</td>
          <td class="p-3 text-center">{% if row.supervisor_done %}‚úÖ{% else %}‚ùå{% endif %}</td>
          <td class="p-3 text-center">{% if row.director_done %}‚úÖ{% else %}‚ùå{% endif %}</td>
          <td class="p-3 text-center">{% if row.has_sent %}üìß{% else %}‚Äî{% endif %}</td>
          <td class="p-3 text-center">{% if row.has_clicked %}üü¢{% else %}‚Äî{% endif %}</td>
          <td class="p-3 text-center sticky right-0 bg-white">
              <button type="button" class="edit-row text-gray-700 hover:text-black" title="Edit" data-emp-id="{{ row.employee.id }}">‚úèÔ∏è</button>
              <button type="submit" class="save-row ml-2 bg-gray-100 px-2 py-1 rounded hover:bg-gray-200" style="display:none;" title="Save" data-emp-id="{{ row.employee.id }}" form="row-form-{{ row.employee.id }}">üíæ</button>
            </form>
            <form method="post" action="/admin/send-review-link/{{ row.employee.id }}" class="inline">
              <button class="ml-2" title="Send email">‚úâÔ∏è</button>
            </form>
            <a href="/director/review/{{ row.employee.id }}" class="ml-3 text-gray-700 hover:underline" title="View compare">üëÅÔ∏è</a>
            <a href="/admin/open-review/{{ row.employee.id }}" class="ml-3 text-gray-700 hover:underline" title="Open as user" target="_blank">üîó</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    
  </div>
  <script>
    (function() {
      function toggleEdit(empId, editing) {
        var roleDisp = document.querySelector('.role-display[data-emp-id="' + empId + '"]');
        var roleSel = document.querySelector('select[data-role-select][data-emp-id="' + empId + '"]');
        var supDisp = document.querySelector('.sup-display[data-emp-id="' + empId + '"]');
        var supSel = document.querySelector('select[data-sup-select][data-emp-id="' + empId + '"]');
        var schedDisp = document.querySelector('.sched-display[data-emp-id="' + empId + '"]');
        var schedInp = document.querySelector('input[data-sched-input][data-emp-id="' + empId + '"]');
        var saveBtn = document.querySelector('button.save-row[data-emp-id="' + empId + '"]');
        var editBtn = document.querySelector('button.edit-row[data-emp-id="' + empId + '"]');
        if (!roleDisp || !roleSel || !supDisp || !supSel || !saveBtn || !editBtn) return;
        if (editing) {
          roleDisp.style.display = 'none';
          supDisp.style.display = 'none';
          if (schedDisp) schedDisp.style.display = 'none';
          roleSel.style.display = '';
          supSel.style.display = '';
          if (schedInp) schedInp.style.display = '';
          roleSel.disabled = false;
          supSel.disabled = false;
          if (schedInp) schedInp.disabled = false;
          saveBtn.style.display = '';
          editBtn.style.display = 'none';
        } else {
          roleDisp.style.display = '';
          supDisp.style.display = '';
          if (schedDisp) schedDisp.style.display = '';
          roleSel.style.display = 'none';
          supSel.style.display = 'none';
          if (schedInp) schedInp.style.display = 'none';
          roleSel.disabled = true;
          supSel.disabled = true;
          if (schedInp) schedInp.disabled = true;
          saveBtn.style.display = 'none';
          editBtn.style.display = '';
          // Update display text with current selections
          var roleText = roleSel.options[roleSel.selectedIndex].textContent;
          roleDisp.textContent = roleText;
          var supText = supSel.options[supSel.selectedIndex] ? supSel.options[supSel.selectedIndex].textContent : '‚Äî';
          supDisp.textContent = supText || '‚Äî';
          if (schedDisp && schedInp) {
            // Convert value "YYYY-MM-DDTHH:MM" to "YYYY-MM-DD HH:MM"
            var v = schedInp.value || '';
            schedDisp.textContent = v ? v.replace('T', ' ') : '‚Äî';
          }
        }
      }
      document.querySelectorAll('button.edit-row').forEach(function(btn){
        btn.addEventListener('click', function(){
          var id = btn.getAttribute('data-emp-id');
          toggleEdit(id, true);
        });
      });

      // Bulk edit supervisors
      var bulkBtn = document.getElementById('bulk-edit-sup');
      var bulkSave = document.getElementById('bulk-save-sup');
      var bulkCancel = document.getElementById('bulk-cancel-sup');
      var bulkMode = false;
      function setBulkMode(on) {
        bulkMode = !!on;
        bulkBtn.style.display = on ? 'none' : '';
        bulkSave.style.display = on ? '' : 'none';
        bulkCancel.style.display = on ? '' : 'none';
        var rows = document.querySelectorAll('#admin-table tbody tr');
        rows.forEach(function(row){
          var empId = row.querySelector('button.edit-row')?.getAttribute('data-emp-id');
          if (!empId) return;
          var supDisp = row.querySelector('.sup-display[data-emp-id="' + empId + '"]');
          var supSel = row.querySelector('select[data-sup-select][data-emp-id="' + empId + '"]');
          if (!supDisp || !supSel) return;
          if (on) {
            supDisp.style.display = 'none';
            supSel.style.display = '';
            supSel.disabled = false;
          } else {
            supDisp.style.display = '';
            supSel.style.display = 'none';
            supSel.disabled = true;
          }
        });
      }
      if (bulkBtn) {
        bulkBtn.addEventListener('click', function(){ setBulkMode(true); });
      }
      if (bulkCancel) {
        bulkCancel.addEventListener('click', function(){ setBulkMode(false); });
      }
      if (bulkSave) {
        bulkSave.addEventListener('click', function(){
          // Create a temporary form and submit all supervisor values
          var form = document.createElement('form');
          form.method = 'post';
          form.action = '/admin/bulk-update-supervisors';
          var rows = document.querySelectorAll('#admin-table tbody tr');
          rows.forEach(function(row){
            var empId = row.querySelector('button.edit-row')?.getAttribute('data-emp-id');
            var supSel = row.querySelector('select[data-sup-select][data-emp-id="' + empId + '"]');
            if (!empId || !supSel) return;
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'supervisor_name[' + empId + ']';
            input.value = supSel.value || '';
            form.appendChild(input);
          });
          document.body.appendChild(form);
          form.submit();
        });
      }

      // Bulk edit roles
      var bulkRoleBtn = document.getElementById('bulk-edit-role');
      var bulkRoleSave = document.getElementById('bulk-save-role');
      var bulkRoleCancel = document.getElementById('bulk-cancel-role');
      function setBulkRoleMode(on) {
        bulkRoleBtn.style.display = on ? 'none' : '';
        bulkRoleSave.style.display = on ? '' : 'none';
        bulkRoleCancel.style.display = on ? '' : 'none';
        var rows = document.querySelectorAll('#admin-table tbody tr');
        rows.forEach(function(row){
          var empId = row.querySelector('button.edit-row')?.getAttribute('data-emp-id');
          if (!empId) return;
          var roleDisp = row.querySelector('.role-display[data-emp-id="' + empId + '"]');
          var roleSel = row.querySelector('select[data-role-select][data-emp-id="' + empId + '"]');
          if (!roleDisp || !roleSel) return;
          if (on) {
            roleDisp.style.display = 'none';
            roleSel.style.display = '';
            roleSel.disabled = false;
          } else {
            roleDisp.style.display = '';
            roleSel.style.display = 'none';
            roleSel.disabled = true;
          }
        });
      }
      if (bulkRoleBtn) bulkRoleBtn.addEventListener('click', function(){ setBulkRoleMode(true); });
      if (bulkRoleCancel) bulkRoleCancel.addEventListener('click', function(){ setBulkRoleMode(false); });
      if (bulkRoleSave) {
        bulkRoleSave.addEventListener('click', function(){
          var form = document.createElement('form');
          form.method = 'post';
          form.action = '/admin/bulk-update-roles';
          var rows = document.querySelectorAll('#admin-table tbody tr');
          rows.forEach(function(row){
            var empId = row.querySelector('button.edit-row')?.getAttribute('data-emp-id');
            var roleSel = row.querySelector('select[data-role-select][data-emp-id="' + empId + '"]');
            if (!empId || !roleSel) return;
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'role[' + empId + ']';
            input.value = roleSel.value || '';
            form.appendChild(input);
          });
          document.body.appendChild(form);
          form.submit();
        });
      }

      // Name filter
      var search = document.getElementById('admin-search');
      var roleFilter = document.getElementById('admin-filter-role');
      var tbody = document.querySelector('#admin-table tbody');
      function applyFilter() {
        var q = (search.value || '').toLowerCase().trim();
        var roleq = (roleFilter && roleFilter.value) ? roleFilter.value.toLowerCase().trim() : '';
        if (!tbody) return;
        tbody.querySelectorAll('tr').forEach(function(row){
          var nameCell = row.querySelector('td');
          var name = nameCell ? (nameCell.textContent || '').toLowerCase() : '';
          var showByName = !q || name.indexOf(q) !== -1;
          var roleDisp = row.querySelector('.role-display');
          var roleTxt = roleDisp ? ((roleDisp.textContent || '').toLowerCase().trim()) : '';
          var showByRole = !roleq || roleTxt === roleq;
          row.style.display = (showByName && showByRole) ? '' : 'none';
        });
      }
      if (search) {
        search.addEventListener('input', applyFilter);
      }
      if (roleFilter) {
        roleFilter.addEventListener('change', applyFilter);
      }
      applyFilter();

      // Sorting
      var currentSort = { key: null, dir: 1 };
      function getCellValue(row, key) {
        switch (key) {
          case 'name':
            return (row.querySelector('td:nth-child(1)')?.textContent || '').trim().toLowerCase();
          case 'role':
            return (row.querySelector('.role-display')?.textContent || '').trim().toLowerCase();
          case 'supervisor':
            return (row.querySelector('.sup-display')?.textContent || '').trim().toLowerCase();
          case 'schedule':
            // Use ISO value if available in hidden input value attr on the row
            var inp = row.querySelector('input[data-sched-input]');
            return (inp && inp.value) ? inp.value : (row.querySelector('.sched-display')?.textContent || '').trim();
          case 'self_done':
            return row.querySelector('td:nth-child(5)')?.textContent.indexOf('‚úÖ') !== -1 ? 1 : 0;
          case 'supervisor_done':
            return row.querySelector('td:nth-child(6)')?.textContent.indexOf('‚úÖ') !== -1 ? 1 : 0;
          case 'director_done':
            return row.querySelector('td:nth-child(7)')?.textContent.indexOf('‚úÖ') !== -1 ? 1 : 0;
          case 'email':
            return row.querySelector('td:nth-child(8)')?.textContent.indexOf('üìß') !== -1 ? 1 : 0;
          case 'clicked':
            return row.querySelector('td:nth-child(9)')?.textContent.indexOf('üü¢') !== -1 ? 1 : 0;
          default:
            return '';
        }
      }
      function compare(a, b, key, dir) {
        var va = getCellValue(a, key);
        var vb = getCellValue(b, key);
        // Try numeric/boolean compare when both are numbers
        if (typeof va === 'number' && typeof vb === 'number') {
          return (va - vb) * dir;
        }
        // Date-like values: ISO yyyy-mm-ddThh:mm sort as string is fine
        va = (va || '').toString();
        vb = (vb || '').toString();
        if (va < vb) return -1 * dir;
        if (va > vb) return 1 * dir;
        return 0;
      }
      function setSortIndicator(th, dir) {
        document.querySelectorAll('th[data-sort] .sort-indicator').forEach(function(el){ el.textContent = ''; });
        var span = th.querySelector('.sort-indicator');
        if (span) span.textContent = dir === 1 ? '‚ñ≤' : '‚ñº';
      }
      document.querySelectorAll('th[data-sort]').forEach(function(th){
        th.addEventListener('click', function(){
          var key = th.getAttribute('data-sort');
          if (!key) return;
          var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
          // Toggle direction if same key
          if (currentSort.key === key) {
            currentSort.dir = -currentSort.dir;
          } else {
            currentSort.key = key;
            currentSort.dir = 1;
          }
          rows.sort(function(a, b){ return compare(a, b, key, currentSort.dir); });
          // Re-append in sorted order
          rows.forEach(function(r){ tbody.appendChild(r); });
          setSortIndicator(th, currentSort.dir);
        });
      });

      // Confirm bulk sends
      document.querySelectorAll('form[data-confirm]').forEach(function(f){
        f.addEventListener('submit', function(e){
          var ok = confirm('‚ö†Ô∏è Are you sure you want to send these emails?');
          if (!ok) {
            e.preventDefault();
          }
        });
      });
    })();
  </script>
</div>
{% endblock %}


