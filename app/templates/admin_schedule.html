{% extends 'base.html' %}
{% block title %}Scheduled Reviews{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto bg-white p-6 rounded-xl shadow space-y-6">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold text-gray-800">Scheduled Reviews</h1>
    <a href="/admin" class="text-blue-600 hover:underline">← Back to Admin</a>
  </div>

  {% if message %}
  <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-2 rounded-lg text-sm">{{ message }}</div>
  {% endif %}
  {% if error %}
  <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-2 rounded-lg text-sm">{{ error }}</div>
  {% endif %}

  <div class="flex items-center justify-between">
    <div class="flex items-center space-x-2">
      <button id="prev-month" class="bg-gray-100 text-gray-800 px-3 py-1 rounded hover:bg-gray-200">◀</button>
      <div id="month-label" class="text-lg font-semibold"></div>
      <button id="next-month" class="bg-gray-100 text-gray-800 px-3 py-1 rounded hover:bg-gray-200">▶</button>
    </div>
    <button id="today-btn" class="bg-gray-100 text-gray-800 px-3 py-1 rounded hover:bg-gray-200">Today</button>
  </div>

  <div class="grid grid-cols-7 gap-2 text-sm">
    <div class="text-gray-500 font-semibold text-center">Sun</div>
    <div class="text-gray-500 font-semibold text-center">Mon</div>
    <div class="text-gray-500 font-semibold text-center">Tue</div>
    <div class="text-gray-500 font-semibold text-center">Wed</div>
    <div class="text-gray-500 font-semibold text-center">Thu</div>
    <div class="text-gray-500 font-semibold text-center">Fri</div>
    <div class="text-gray-500 font-semibold text-center">Sat</div>
  </div>
  <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>

  {# Tabs below calendar #}
  <div class="mt-6 border border-gray-200 rounded-xl overflow-hidden">
    <div class="flex border-b border-gray-200 bg-gray-100">
      <button type="button" id="tab-upcoming" class="schedule-tab px-4 py-3 text-sm font-medium text-gray-700 bg-white border-b-2 border-blue-600 -mb-px" data-panel="panel-upcoming">Upcoming</button>
      <button type="button" id="tab-pending" class="schedule-tab px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-panel="panel-pending">Pending scheduling</button>
    </div>
    <div id="panel-upcoming" class="schedule-panel p-4 bg-white">
      <div id="flat-list" class="space-y-1 text-sm text-gray-700"></div>
    </div>
    <div id="panel-pending" class="schedule-panel p-4 bg-white hidden">
      <p class="text-sm text-gray-600 mb-4">Employees with both employee and supervisor reviews done. Pick a date and a 15‑minute slot to schedule the meeting.</p>
      {% if ready_to_schedule %}
      <div class="space-y-3">
        {% for item in ready_to_schedule %}
        <div class="flex flex-wrap items-center gap-3 py-2 border-b border-slate-200 last:border-0">
          <span class="font-medium text-gray-800 min-w-[140px]">{{ item.name }}</span>
          {% if item.scheduled_display %}
          <span class="text-sm text-gray-500">Currently: {{ item.scheduled_display }}</span>
          {% endif %}
          <form action="/admin/schedule-employee/{{ item.employee_id }}" method="post" class="flex flex-wrap items-center gap-2">
            <input type="date" name="date" required class="border border-gray-300 rounded px-2 py-1.5 text-sm" value="{{ (item.scheduled_at[:10] if item.scheduled_at else '') }}">
            <select name="time" required class="border border-gray-300 rounded px-2 py-1.5 text-sm">
              <option value="">Time</option>
              {% for h in range(24) %}
                {% for m in [0, 15, 30, 45] %}
              {% set slot = "%02d"|format(h) ~ ":" ~ "%02d"|format(m) %}
              <option value="{{ slot }}"{% if item.scheduled_time == slot %} selected{% endif %}>{{ slot }}</option>
                {% endfor %}
              {% endfor %}
            </select>
            <button type="submit" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700">Schedule</button>
          </form>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-sm text-gray-500">No one has both reviews completed yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function(){
  var tabButtons = document.querySelectorAll('.schedule-tab');
  var panels = document.querySelectorAll('.schedule-panel');
  function showPanel(panelId) {
    panels.forEach(function(p){ p.classList.add('hidden'); });
    tabButtons.forEach(function(b){
      b.classList.remove('bg-white', 'border-b-2', 'border-blue-600', '-mb-px');
      b.classList.add('text-gray-500');
    });
    var panel = document.getElementById(panelId);
    if (panel) panel.classList.remove('hidden');
    var btn = document.querySelector('.schedule-tab[data-panel="' + panelId + '"]');
    if (btn) {
      btn.classList.add('bg-white', 'border-b-2', 'border-blue-600', '-mb-px');
      btn.classList.remove('text-gray-500');
    }
  }
  tabButtons.forEach(function(btn){
    btn.addEventListener('click', function(){ showPanel(btn.getAttribute('data-panel')); });
  });
})();
</script>

<script>
(function(){
  var events = {{ events_json | safe }} || [];
  // Parse to Date
  events = events.map(function(e){
    var d = new Date(e.iso);
    return { employee: e.employee, iso: e.iso, date: d };
  });
  var state = (function(){
    var now = new Date();
    return { year: now.getFullYear(), month: now.getMonth() };
  })();
  var monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  var monthLabel = document.getElementById('month-label');
  var grid = document.getElementById('calendar-grid');
  function sameDay(a, b){
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }
  function render() {
    var first = new Date(state.year, state.month, 1);
    var last = new Date(state.year, state.month + 1, 0);
    monthLabel.textContent = monthNames[state.month] + " " + state.year;
    grid.innerHTML = "";
    var startOffset = first.getDay(); // 0-6, Sun=0
    var daysInMonth = last.getDate();
    var totalCells = Math.ceil((startOffset + daysInMonth) / 7) * 7;
    for (var i = 0; i < totalCells; i++) {
      var cell = document.createElement('div');
      cell.className = "border rounded p-2 min-h-[80px]";
      var dayNum = i - startOffset + 1;
      if (dayNum >= 1 && dayNum <= daysInMonth) {
        var dayDate = new Date(state.year, state.month, dayNum);
        var header = document.createElement('div');
        header.className = "text-xs font-semibold text-gray-700 mb-1";
        header.textContent = dayNum;
        cell.appendChild(header);
        // events for this day
        var dayEvents = events.filter(function(ev){ return sameDay(ev.date, dayDate); });
        if (dayEvents.length) {
          dayEvents.forEach(function(ev){
            var time = ev.date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            var item = document.createElement('div');
            item.className = "text-xs bg-blue-50 text-blue-700 rounded px-2 py-1 mb-1";
            item.textContent = time + " — " + ev.employee;
            cell.appendChild(item);
          });
        } else {
          var empty = document.createElement('div');
          empty.className = "text-xs text-gray-400";
          empty.textContent = "—";
          cell.appendChild(empty);
        }
      } else {
        cell.className += " bg-gray-50";
      }
      grid.appendChild(cell);
    }
    renderFlatList();
  }
  function renderFlatList() {
    var list = document.getElementById('flat-list');
    var start = new Date(state.year, state.month, 1);
    var end = new Date(state.year, state.month + 1, 0, 23, 59, 59);
    var filtered = events.filter(function(ev){ return ev.date >= start && ev.date <= end; });
    filtered.sort(function(a,b){ return a.date - b.date; });
    if (!filtered.length) {
      list.innerHTML = '<div class="text-gray-400">No scheduled items this month.</div>';
      return;
    }
    list.innerHTML = filtered.map(function(ev){
      var d = ev.date.toLocaleDateString();
      var t = ev.date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      return '<div>' + d + ' ' + t + ' — ' + ev.employee + '</div>';
    }).join('');
  }
  document.getElementById('prev-month').addEventListener('click', function(){
    state.month -= 1;
    if (state.month < 0) { state.month = 11; state.year -= 1; }
    render();
  });
  document.getElementById('next-month').addEventListener('click', function(){
    state.month += 1;
    if (state.month > 11) { state.month = 0; state.year += 1; }
    render();
  });
  document.getElementById('today-btn').addEventListener('click', function(){
    var now = new Date();
    state.year = now.getFullYear();
    state.month = now.getMonth();
    render();
  });
  render();
})();
</script>
{% endblock %}


