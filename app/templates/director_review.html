{% extends 'base.html' %}
{% block title %}Director Final Review{% endblock %}

{% block content %}
<div class="flex flex-col lg:grid lg:grid-cols-2 gap-0 max-w-[1800px] mx-auto bg-white rounded-xl shadow min-h-[calc(100vh-8rem)]">
  {# Left column: 50% ‚Äî Self + Supervisor responses; scrolls with page #}
  <div class="w-full min-w-0 p-6 lg:p-8 order-2 lg:order-1 border-r border-gray-200">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Final Review of {{ employee.name }}</h1>

    {% if employee_score is not none or supervisor_score is not none %}
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 mb-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">üìä Overall Scores</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
          <div class="text-sm text-gray-600 mb-1">Employee Self-Review Score</div>
          <div class="text-3xl font-bold text-blue-600">
            {% if employee_score_str %}
              {{ employee_score_str }}<span class="text-lg text-gray-500">/5.00</span>
            {% else %}
              <span class="text-gray-400">N/A</span>
            {% endif %}
          </div>
          {% if employee_score is not none %}
          <div class="mt-2">
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div class="bg-blue-600 h-2.5 rounded-full" style="width: {{ (employee_score / 5 * 100)|round }}%"></div>
            </div>
          </div>
          {% endif %}
        </div>
        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
          <div class="text-sm text-gray-600 mb-1">Supervisor Review Score</div>
          <div class="text-3xl font-bold text-indigo-600">
            {% if supervisor_score_str %}
              {{ supervisor_score_str }}<span class="text-lg text-gray-500">/5.00</span>
            {% else %}
              <span class="text-gray-400">N/A</span>
            {% endif %}
          </div>
          {% if supervisor_score is not none %}
          <div class="mt-2">
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div class="bg-indigo-600 h-2.5 rounded-full" style="width: {{ (supervisor_score / 5 * 100)|round }}%"></div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
      {% if employee_score is not none and supervisor_score is not none %}
      <div class="mt-4 pt-4 border-t border-blue-200">
        <div class="text-sm text-gray-600">
          <span class="font-semibold">Difference:</span>
          {% if score_diff is not none %}
            {% if score_diff > 0 %}
              <span class="text-green-600">Supervisor scored {{ score_diff_str }} points higher</span>
            {% elif score_diff < 0 %}
              <span class="text-orange-600">Employee scored {{ score_diff_str }} points higher</span>
            {% else %}
              <span class="text-gray-600">Scores are identical</span>
            {% endif %}
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}

    {# Perguntas com respostas Self | Supervisor lado a lado #}
    {% set ns = namespace(current_category=None) %}
    {% for q in questions %}
      {% if q.category != ns.current_category %}
        <h2 class="text-xl font-bold text-gray-800 mt-10 mb-3 border-b border-gray-200 pb-1">{{ q.category }}</h2>
        {% set ns.current_category = q.category %}
      {% endif %}

      <div class="mb-6 pb-4 border-b border-gray-100">
        <p class="font-semibold text-gray-800 mb-3">{{ q.question }}</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
            <span class="font-semibold text-blue-700">Self</span>
            <div class="mt-1 text-gray-700">
              {% set ans = review.employee_answers[loop.index0] %}
              {{ ans.value }}
            </div>
          </div>
          <div class="bg-indigo-50 rounded-lg p-3 border border-indigo-200">
            <span class="font-semibold text-indigo-700">Supervisor</span>
            <div class="mt-1 text-gray-700">
              {% set s = supervisor_map.get(q.question) %}
              {% if s %}
                {{ s.value }}
                {% if s.comment %}
                  <p class="mt-2 text-gray-500 italic">Comment: {{ s.comment }}</p>
                {% endif %}
              {% else %}
                ‚Äî
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  {# Right column: 50% ‚Äî Rating Scale + summary; sticky so it stays visible while left side scrolls #}
  <div class="w-full min-w-0 order-1 lg:order-2 lg:sticky lg:top-4 lg:self-start lg:max-h-[calc(100vh-2rem)] lg:overflow-y-auto">
    <div class="p-6 lg:p-8 bg-gray-50/80 space-y-4">
    {# Rating scale #}
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
      {% if rating_panel_html %}
        {{ rating_panel_html | safe }}
      {% else %}
        <div class="px-4 py-3 border-b border-gray-100 font-bold text-gray-800">Rating Scale</div>
        <div class="p-4">
          <table class="w-full text-sm text-gray-700 border-collapse">
            <thead>
              <tr class="text-left text-gray-500 border-b border-gray-200">
                <th class="pb-2 pr-2">Score</th>
                <th class="pb-2 pr-2">Meaning</th>
                <th class="pb-2">Example</th>
              </tr>
            </thead>
            <tbody>
              <tr class="border-b border-gray-100"><td class="py-1.5 pr-2">5</td><td class="py-1.5 pr-2">Outstanding</td><td class="py-1.5">Goes above and beyond</td></tr>
              <tr class="border-b border-gray-100"><td class="py-1.5 pr-2">4</td><td class="py-1.5 pr-2">Above Average</td><td class="py-1.5">Often exceeds expectations</td></tr>
              <tr class="border-b border-gray-100"><td class="py-1.5 pr-2">3</td><td class="py-1.5 pr-2">Meets Expectations</td><td class="py-1.5">Reliable and consistent</td></tr>
              <tr class="border-b border-gray-100"><td class="py-1.5 pr-2">2</td><td class="py-1.5 pr-2">Needs Improvement</td><td class="py-1.5">Requires closer supervision</td></tr>
              <tr><td class="py-1.5 pr-2">1</td><td class="py-1.5 pr-2">Not Meeting Standards</td><td class="py-1.5">Unsafe or unprofessional</td></tr>
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>

    {# Employee info (expandable) ‚Äî between Rating Scale and Summary #}
    <details class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden group" id="employee-info-details">
      <summary class="px-4 py-3 border-b border-gray-100 font-bold text-gray-800 cursor-pointer select-none hover:bg-gray-50 flex items-center justify-between list-none [&::-webkit-details-marker]:hidden">
        <span>üë§ {{ employee.name }} ‚Äî profile</span>
        <span class="text-gray-400 text-sm font-normal group-open:hidden">expand</span>
        <span class="text-gray-400 text-sm font-normal hidden group-open:inline">collapse</span>
      </summary>
      <div class="p-4 text-sm text-gray-700 space-y-2">
        {% if employee.department %}<div><span class="font-semibold text-gray-600">Department:</span> {{ employee.department }}</div>{% endif %}
        {% if employee.position %}<div><span class="font-semibold text-gray-600">Position:</span> {{ employee.position }}</div>{% endif %}
        {% if employee.years_months_with_mk %}<div><span class="font-semibold text-gray-600">Years/Months with MK:</span> {{ employee.years_months_with_mk }}</div>{% endif %}
        {% if employee.pay_hr_last_3_years %}<div><span class="font-semibold text-gray-600">Pay/hr (last 3 years):</span> {{ employee.pay_hr_last_3_years }}</div>{% endif %}
        {% if employee.loan_amount %}<div><span class="font-semibold text-gray-600">Loan amount:</span> {{ employee.loan_amount }}</div>{% endif %}
        {% if employee.lmia %}<div><span class="font-semibold text-gray-600">LMIA:</span> {{ employee.lmia }}</div>{% endif %}
        {% if employee.company_phone %}<div><span class="font-semibold text-gray-600">Company phone:</span> {{ employee.company_phone }}</div>{% endif %}
        {% if employee.company_laptop_ipad %}<div><span class="font-semibold text-gray-600">Company laptop/iPad:</span> {{ employee.company_laptop_ipad }}</div>{% endif %}
        {% if employee.drive_company_vehicle %}<div><span class="font-semibold text-gray-600">Drive company vehicle:</span> {{ employee.drive_company_vehicle }}</div>{% endif %}
        {% if employee.company_gas_card %}<div><span class="font-semibold text-gray-600">Company gas card:</span> {{ employee.company_gas_card }}</div>{% endif %}
        {% if employee.skills_trade_completed %}<div><span class="font-semibold text-gray-600">Skills trade completed:</span> {{ employee.skills_trade_completed }}</div>{% endif %}
        {% if employee.safety_infraction_description %}
        <div class="pt-2 border-t border-gray-100">
          <span class="font-semibold text-gray-600">Safety infraction:</span>
          <div class="mt-1 text-gray-600 whitespace-pre-wrap">{{ employee.safety_infraction_description }}</div>
        </div>
        {% endif %}
        {% if not (employee.department or employee.position or employee.years_months_with_mk or employee.pay_hr_last_3_years or employee.loan_amount or employee.lmia or employee.company_phone or employee.company_laptop_ipad or employee.drive_company_vehicle or employee.company_gas_card or employee.skills_trade_completed or employee.safety_infraction_description) %}
        <p class="text-gray-500">No profile info on file.</p>
        {% endif %}
      </div>
    </details>

    {% if allow_comments %}
    <form method="post" action="/director/review/{{ employee.id }}/submit" class="space-y-3">
      <h2 class="text-lg font-bold text-gray-800">üìù Your summary for the meeting</h2>
      <p class="text-sm text-gray-600">Write whatever you want: opinions, points to discuss, notes to read in the personal meeting.</p>
      <textarea name="director_summary" rows="14" class="w-full border border-gray-300 p-3 rounded-lg text-sm resize-y min-h-[200px]" placeholder="Your notes and opinions to use in the meeting‚Ä¶">{{ director_summary or '' }}</textarea>
      <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition shadow-sm">
        üíæ Save summary
      </button>
    </form>
    {% else %}
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <h2 class="text-lg font-bold text-gray-800 mb-2">Summary for the meeting</h2>
      {% if director_summary %}
        <div class="text-gray-700 whitespace-pre-wrap text-sm">{{ director_summary }}</div>
      {% else %}
        <p class="text-gray-500 text-sm">No summary saved.</p>
      {% endif %}
    </div>
    {% endif %}
    </div>
  </div>
</div>
{% endblock %}
