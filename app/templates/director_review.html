{% extends 'base.html' %}
{% block title %}Director Final Review{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto bg-white p-8 rounded-xl shadow space-y-6">
  <h1 class="text-3xl font-bold text-gray-800">Final Review of {{ employee.name }}</h1>

  {% if employee_score is not none or supervisor_score is not none %}
  <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 mb-6">
    <h2 class="text-xl font-bold text-gray-800 mb-4">ðŸ“Š Overall Scores</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
        <div class="text-sm text-gray-600 mb-1">Employee Self-Review Score</div>
        <div class="text-3xl font-bold text-blue-600">
          {% if employee_score_str %}
            {{ employee_score_str }}<span class="text-lg text-gray-500">/5.00</span>
          {% else %}
            <span class="text-gray-400">N/A</span>
          {% endif %}
        </div>
        {% if employee_score is not none %}
        <div class="mt-2">
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div class="bg-blue-600 h-2.5 rounded-full" style="width: {{ (employee_score / 5 * 100)|round }}%"></div>
          </div>
        </div>
        {% endif %}
      </div>
      <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
        <div class="text-sm text-gray-600 mb-1">Supervisor Review Score</div>
        <div class="text-3xl font-bold text-indigo-600">
          {% if supervisor_score_str %}
            {{ supervisor_score_str }}<span class="text-lg text-gray-500">/5.00</span>
          {% else %}
            <span class="text-gray-400">N/A</span>
          {% endif %}
        </div>
        {% if supervisor_score is not none %}
        <div class="mt-2">
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div class="bg-indigo-600 h-2.5 rounded-full" style="width: {{ (supervisor_score / 5 * 100)|round }}%"></div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    {% if employee_score is not none and supervisor_score is not none %}
    <div class="mt-4 pt-4 border-t border-blue-200">
      <div class="text-sm text-gray-600">
        <span class="font-semibold">Difference:</span>
        {% if score_diff is not none %}
          {% if score_diff > 0 %}
            <span class="text-green-600">Supervisor scored {{ score_diff_str }} points higher</span>
          {% elif score_diff < 0 %}
            <span class="text-orange-600">Employee scored {{ score_diff_str }} points higher</span>
          {% else %}
            <span class="text-gray-600">Scores are identical</span>
          {% endif %}
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <form method="post" action="/director/review/{{ employee.id }}/submit" class="space-y-6">

{% set ns = namespace(current_category=None) %}
{% for q in questions %}
  {% if q.category != ns.current_category %}
    <h2 class="text-xl font-bold text-gray-800 mt-10 border-b pb-1">{{ q.category }}</h2>
    {% if allow_comments %}
    <div class="mb-4">
      <textarea name="sc_{{ category_slugs.get(q.category) }}" rows="2" class="w-full border border-gray-300 p-2 rounded" placeholder="Director section comment">{{ section_map.get(q.category, '') }}</textarea>
    </div>
    {% else %}
      {% if section_map.get(q.category) %}
      <div class="text-sm text-gray-600 mb-2"><span class="font-semibold">Director section note:</span> {{ section_map.get(q.category) }}</div>
      {% endif %}
    {% endif %}
    {% set ns.current_category = q.category %}
  {% endif %}

      {% set idx = loop.index0 %}
      <div>
        <p class="font-semibold text-gray-700 mb-1">{{ q.question }}</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600 mb-2">
          <div>
            <span class="font-semibold">Self:</span>
            {% set ans = review.employee_answers[idx] %}
            {{ ans.value }}
          </div>
          <div>
            <span class="font-semibold">Supervisor:</span>
            {% set s = supervisor_map.get(q.question) %}
            {% if s %}
              {{ s.value }}
              {% if s.comment %}
                <br><em class="text-gray-500">Comment: {{ s.comment }}</em>
              {% endif %}
            {% else %}
              â€”
            {% endif %}
          </div>
        </div>
        {% if allow_comments %}
        <textarea name="c{{ q.id }}" rows="3" class="w-full border border-gray-300 p-2 rounded" placeholder="Director comment">{{ comment_map.get(q.question, '') }}</textarea>
        {% else %}
        {% if comment_map.get(q.question) %}
        <div class="text-sm text-gray-600"><span class="font-semibold">Director comment:</span> {{ comment_map.get(q.question) }}</div>
        {% endif %}
        {% endif %}
      </div>
    {% endfor %}

    {% if allow_comments %}
      <div class="text-right">
        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
          ðŸ’¾ Save Comments
        </button>
      </div>
    {% endif %}
  </form>
</div>
{% endblock %}
{% include '_rating_scale.html' %}
